# マルウェア解析者になるための勉強方法(work-in-progress)

`これは@PINKSAWTOOTHの私見で、必ずしもあなたにとって一番良い方法ではないかもしれません。勉強方法の一例として参照しもらえれば幸いです。`

これを読む前に、僕が尊敬するマルウェア解析者の@hasherezade氏がマルウェア解析の勉強をどのように始めたらよいかをブログにしています。
重複する部分があると思いますが、一読することをおすすめします。また、以下のブログは英語のソースが中心なので、可能な限り日本語を中心にしたソースを紹介したいと思います。

https://hshrzd.wordpress.com/how-to-start/

# マルウェア解析の前提となる知識

まず、マルウェア解析の前提となる知識について簡単に説明します。
マルウェア解析について学ぶ前に、最低限コンピュータサイエンス(計算機科学)の知識が必要になります。

- コンピュータアーキテクチャ
- コンピュータネットワーク
- オペレーティングシステム
- プログラミング言語
- データ構造とアルゴリズム
- etc...

これらについては、大学や専門学校で履修するないようが理解できていればよいかと思います。
(どこかの大学のオンラインシラバス等を確認することで、より具体的な内容を知れるかと思います。)
本稿では、コンピュータサイエンスをどのように学ぶかはスコープ外としますが、以下がおすすめの資料です。

- [コンピュータはなぜ動くのか 知っておきたいハードウエア＆ソフトウエアの基礎知識](https://www.nikkeibp.co.jp/atclpubmkt/book/03/P81650/)
- [プログラムはなぜ動くのか 第３版　知っておきたいプログラミングの基礎知識] (https://www.nikkeibp.co.jp/atclpubmkt/book/21/S00190/)
- [インテル® 64および IA-32 アーキテクチャのソフトウェア開発者向けマニュアル (最新)](https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、上巻: 基本アーキテクチャー (日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol1_Online_i.pdf)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、中巻 A: 命令セット・リファレンス A-M(日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol2A_i.pdf)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、中巻 B: 命令セット・リファレンス N-Z(日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol2B_i.pdf)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、下巻: システム・プログラミング・ガイド(日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol3_i.pdf)
- [マスタリングTCP/IP　入門編（第6版](https://www.ohmsha.co.jp/book/9784274224478/)

## マルウェア解析に必要となる知識

マルウェア解析に必要となる知識を大きく以下の5つに分けます。

- マルウェア解析技術、マルウェアの挙動、悪用するテクニックの実装や実現方法に関する知識
- リバースエンジニアリング対象のプログラム開発に関する知識
- リバースエンジニアリングに関する知識
- 解析ツールに関する知識

### マルウェア解析技術についての知識

ますは、マルウェア解析とは何を行う作業なのかを学ぶ必要があります。
マルウェア解析全般について学ぶのにおすすめの資料を紹介します。

- [セキュリティ・キャンプ全国大会2015でのマルウエア分析講義](https://blogs.jpcert.or.jp/ja/2015/09/seccamp.html)
  - セキュリティ・キャンプ全国大会2015で開催された 

情報処理学会コンピュータセキュリティ(CSEC)研究会配下のMWS組織員会が主催するマルウェア解析技術を競うコンテスト、[MWS Cup](https://www.iwsec.org/mws/mwscup.html)があります。
Webページで過去の問題内容や解説が公開されており、参考になります。

### マルウェア解析技術、マルウェアの挙動、悪用するテクニックの実装や実現方法に関する知識



### リバースエンジニアリング対象のプログラム開発に関する知識

リバースエンジニアリングは、マルウェア解析において一部でしかありませんが、マルウェア解析者になるためには避けて通れない道です。
サンドボックスを使った動的解析やツールを使った動的解析(手動でおこなうデバッグを除く)だけでは、マルウェアの機能の全容や使用されているアルゴリズムを特定することは困難です。

リバースエンジニアリングをおこなうためには、元のソースコードについて理解しておく必要があります。
（マルウェア解析で一般的なWindows環境を想定しますが）Windows APIを使ったプログラミングの経験なしにマルウェア解析をするのは遠回りになるでしょう。

幸いなことにWindows APIはMicrosoftが公式のドキュメントを公開しており、詳細についてはWeb上で確認することができます。
`日本語のページがある場合がありますが、英語のページのほうが記載が充実しています。Google翻訳を使ってもいいので英語版を読むようにしましょう。`

https://docs.microsoft.com/en-us/

例としてCreateFile関数の[ページ](https://docs.microsoft.com/ja-jp/windows/win32/api/fileapi/nf-fileapi-createfilea)を記載します。

![image](https://user-images.githubusercontent.com/18203311/120811986-89e9f480-c587-11eb-8bb0-61c8d4e10a91.png)

また、Windows APIのサンプルも同ページに記載されている場合があります。こういった　　

![image](https://user-images.githubusercontent.com/18203311/120793123-792e8400-c571-11eb-836b-2b7f2305fb8c.png)
![image](https://user-images.githubusercontent.com/18203311/120795426-68cbd880-c574-11eb-8c07-923b07d91803.png)

### 解析ツールに関する知識

マルウェア解析をすすめるうえで、よりよいツールを使うことやツールを使いこなすことで容易に解析できることがあります。
また、様々な知識を持っていても実際にツールを通して解析するため、ツールの利用方法も理解しておく必要があります。

解析ツールのインストールや更新などの管理のために、FireEyeが[Flare VM](https://github.com/fireeye/flare-vm)をリリースしておりWindowsの仮想環境上で簡単に解析ツールの管理をおこなうことができます。
[Flare VMによってインストールされるツールの一覧](https://github.com/fireeye/flare-vm)を確認し、それぞれの使い方を学ぶことでマルウェア解析者に一般的に利用されるソフトウェアを使いこなすことができます。

## マルウェアの入手

## 前置き

ここではマルウェアの入手方法について触れますが、紹介するサービスを利用する際は利用規約を必ず読んで利用してください。
また、以下の内容は、マルウェアの入手を勧めるものではありません。

正当な理由なくマルウェア(法律的には不正指令電磁的記録)を作成、取得・保管することは法律で禁止されています。
どういった理由であれば法律上の`正当な理由`にあたるかは、法律の専門家ではないためわかりません。
個人の趣味でマルウェア解析をおこなうことは`正当な理由`として認めら得ない可能性もあります。
捜査されると困る、裁判になったら困る、正当な理由として提示できる活動実績がある、弁護費用がないなど、平穏な人生を絶対に送りたいという人は、個人の趣味でやらないほうがよいかと思います。

とはいえ過度に怯えすぎて萎縮する必要はないとは思います。
最低限、警視庁が公開している不正指令電磁的記録に関する罪に関するページには目を通して、内容を確認しておきましょう。

- https://www.keishicho.metro.tokyo.jp/kurashi/cyber/law/virus.html

マルウェアを扱う上で気にしなければ行けないことは、法律面だけではありません。
マルウェアを実行(故意かどうかは問わない)すると、たいていの場合は攻撃者の用意したサーバにアクセスします。
攻撃者のサーバには自分の利用しているIPアドレスのログが残りますし、接続時に利用しているシステムの情報を送信することもあります。
マルウェアによっては、攻撃者によるコマンドの実行などがおこなわれることも考えられますし、内部ネットワークのスキャンや(一番避けるべき)外部への感染活動などがおこなわれるかもしれません。
攻撃者のサーバに記録された情報は攻撃者自身だけでなく、第三者へ提供されることもあります。また、捜査機関はサーバを差し押さえてログを解析したうえで、ISPに情報開示請求をおこなうことができます。

以下のどれか一つにでも当てはまる場合は、実際のマルウェアを利用した学習は控えましょう。

- マルウェアを取り扱う上で、不安がある。
- マルウェア解析のための専用PCや独立したネットワークなど隔離した環境を用意できない。
- 未成年もしくは学生であるが、マルウェアを扱った解析や研究をするうえで責任者がいない(社会人の場合は、全て自己責任として責任を取れない)。

実際のマルウェアを個人的に入手しなくても、学習する方法は前述しております。
オタクがみんな大好きな以下の名言たちで前置きを終えます。
- `With great power comes great responsibility`
- `The abyss gazes also into you.`

## マルウェア共有サービス/IoC共有サービス

マルウェアのサンプルやIoCを共有するためのサービスがいくつかあります。もっとも登録が多く有名なサービスはVirusTotalですが、有償アカウントのみダウンロードが可能であるため、ここでは無償で利用可能なサービスを紹介します。

- [malpedia](https://malpedia.caad.fkie.fraunhofer.de/)
- [MalwareBazaar](https://bazaar.abuse.ch/)
- [URLhaus](https://urlhaus.abuse.ch/)
- [ThreatFox](https://threatfox.abuse.ch/)
- [MalShare](https://www.malshare.com/)
- [VirusShare](https://virusshare.com/)
- [VirusBay](https://beta.virusbay.io/)
- [Vxvaul](http://vxvault.net//ViriList.php)
- [theZoo](https://thezoo.morirt.com/)

## オンラインサンドボックス

無料で使用できるオンラインサンドボックスのサービスは本来マルウェアの挙動を解析するサービスですが、他者の投稿したマルウェアをダウンロードすることができます。

- [Hybrid Analysis](https://www.hybrid-analysis.com/)
- [Any Run](https://app.any.run/)
- [Triage](https://tria.ge/)
- [Joe Sandbox](https://www.joesandbox.com/)
- [cape](https://capesandbox.com/)
- [Cuckoo Sandbox](https://cuckoo.cert.ee/)
